<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SparkPoint</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav>
        <div class="container">
            <div class="logo">‚ö° SparkPoint</div>
            <div class="wallet-section">
                <span id="wallet">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</span>
                <button id="connect" class="btn-gold">–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
            </div>
        </div>
    </nav>

    <div class="container main">
        <div class="sidebar">
            <div class="card">
                <h3>üë§ –ü—Ä–æ—Ñ–∏–ª—å</h3>
                <div id="profile">
                    <p>–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫</p>
                </div>
            </div>
            
            <div class="card">
                <h3>üí∞ –ë–∞–ª–∞–Ω—Å</h3>
                <div class="balance">
                    <h2 id="balance">0 BNB</h2>
                </div>
            </div>
            
            <div class="card">
                <h3>üìä –£—Ä–æ–≤–µ–Ω—å</h3>
                <div class="level">
                    <span id="level" class="level-badge">0</span>
                    <div class="progress">
                        <div id="progress-bar"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="content">
            <div class="card">
                <h3>üîó –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞</h3>
                <div class="referral">
                    <input type="text" id="ref-link" readonly>
                    <button onclick="copyLink()" class="btn-gold">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
                <small>–û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –¥—Ä—É–∑—å—è–º</small>
            </div>

            <div class="card" id="register-card">
                <h3>üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
                <input type="text" id="upline" placeholder="–ê–¥—Ä–µ—Å –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—è">
                <button onclick="register()" class="btn-green">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è (0.1 BNB)</button>
            </div>

            <div class="card" id="stats-card">
                <h3>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <div class="stats">
                    <div class="stat">
                        <h4 id="refs">0</h4>
                        <p>–†–µ—Ñ–µ—Ä–∞–ª—ã</p>
                    </div>
                    <div class="stat">
                        <h4 id="team">0</h4>
                        <p>–ö–æ–º–∞–Ω–¥–∞</p>
                    </div>
                    <div class="stat">
                        <h4 id="earned">0</h4>
                        <p>–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</p>
                    </div>
                </div>
            </div>

            <div class="card admin-card" id="admin-panel">
                <h3>‚öôÔ∏è –ê–¥–º–∏–Ω</h3>
                <input type="text" id="new-user" placeholder="–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å">
                <input type="text" id="new-upline" placeholder="–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å">
                <button onclick="addFree()" class="btn-green">–î–æ–±–∞–≤–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ</button>
                <input type="number" id="new-fee" placeholder="–ù–æ–≤–∞—è –∫–æ–º–∏—Å—Å–∏—è">
                <button onclick="changeFee()" class="btn-red">–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–º–∏—Å—Å–∏—é</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <script>
        let web3, contract, user;
        const CONTRACT_ADDRESS = "–í–ê–®_–ê–î–†–ï–°_–ö–û–ù–¢–†–ê–ö–¢–ê";
        const CONTRACT_ABI = [ /* –í—Å—Ç–∞–≤—å—Ç–µ ABI —Å—é–¥–∞ */ ];
        
        async function connectWallet() {
            if(window.ethereum) {
                web3 = new Web3(window.ethereum);
                await ethereum.request({method: 'eth_requestAccounts'});
                const accounts = await web3.eth.getAccounts();
                user = accounts[0];
                document.getElementById('wallet').textContent = user.slice(0,6)+'...'+user.slice(-4);
                contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                loadData();
            } else {
                alert("–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ MetaMask");
            }
        }
        
        async function loadData() {
            const userData = await contract.methods.users(user).call();
            
            if(userData.active) {
                document.getElementById('profile').innerHTML = `
                    <p><strong>–£—Ä–æ–≤–µ–Ω—å:</strong> ${userData.level}</p>
                    <p><strong>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å:</strong> ${userData.upline.slice(0,6)}...</p>
                `;
                document.getElementById('balance').textContent = 
                    web3.utils.fromWei(userData.balance, 'ether') + ' BNB';
                document.getElementById('level').textContent = userData.level;
                document.getElementById('refs').textContent = userData.referrals;
                document.getElementById('team').textContent = userData.totalTeam;
                document.getElementById('earned').textContent = 
                    web3.utils.fromWei(userData.balance, 'ether') + ' BNB';
                
                document.getElementById('register-card').style.display = 'none';
                document.getElementById('stats-card').style.display = 'block';
                
                const admin = await contract.methods.admin().call();
                if(user.toLowerCase() === admin.toLowerCase()) {
                    document.getElementById('admin-panel').style.display = 'block';
                }
                
                updateProgress(userData.level, userData.totalTeam);
            } else {
                document.getElementById('profile').innerHTML = '<p>–ù–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</p>';
                document.getElementById('register-card').style.display = 'block';
                document.getElementById('stats-card').style.display = 'none';
            }
            
            updateReferralLink();
        }
        
        function updateProgress(level, team) {
            const requirements = [0,2,6,14,30,62,2,6,14,30,62];
            const req = requirements[level] || 0;
            const progress = req > 0 ? Math.min((team / req) * 100, 100) : 0;
            document.getElementById('progress-bar').style.width = progress + '%';
        }
        
        function updateReferralLink() {
            const link = window.location.origin + '?ref=' + user;
            document.getElementById('ref-link').value = link;
        }
        
        function copyLink() {
            const link = document.getElementById('ref-link');
            link.select();
            document.execCommand('copy');
            alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!');
        }
        
        async function register() {
            const upline = document.getElementById('upline').value || await contract.methods.admin().call();
            const fee = await contract.methods.fee().call();
            
            await contract.methods.register(upline).send({
                from: user,
                value: fee,
                gas: 500000
            });
            
            alert('–£—Å–ø–µ—à–Ω–æ!');
            loadData();
        }
        
        async function addFree() {
            const newUser = document.getElementById('new-user').value;
            const upline = document.getElementById('new-upline').value;
            
            await contract.methods.addFree(newUser, upline).send({from: user});
            alert('–î–æ–±–∞–≤–ª–µ–Ω!');
        }
        
        async function changeFee() {
            const newFee = document.getElementById('new-fee').value;
            const wei = web3.utils.toWei(newFee, 'ether');
            await contract.methods.setFee(wei).send({from: user});
            alert('–ò–∑–º–µ–Ω–µ–Ω–æ!');
        }
        
        window.onload = function() {
            const url = new URL(window.location);
            const ref = url.searchParams.get('ref');
            if(ref) {
                document.getElementById('upline').value = ref;
            }
        };
        
        document.getElementById('connect').onclick = connectWallet;
    </script>
</body>
</html>
